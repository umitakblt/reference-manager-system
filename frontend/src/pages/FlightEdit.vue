<template>
  <div class="flight-edit">
    <el-card>
      <template #header>
        <h2>U√ßu≈ü D√ºzenle</h2>
      </template>
      
      <div v-if="loading" class="loading">
        <el-skeleton :rows="10" animated />
      </div>
      
      <el-form 
        v-else
        :model="flightForm" 
        :rules="rules" 
        ref="flightFormRef" 
        label-width="120px"
        @submit.prevent="handleSubmit"
      >
        <el-row :gutter="20">
          <el-col :span="12">
            <el-form-item label="U√ßu≈ü No" prop="flightNumber">
              <el-input v-model="flightForm.flightNumber" placeholder="U√ßu≈ü numarasƒ±" />
            </el-form-item>
          </el-col>
          
          <el-col :span="12">
            <el-form-item label="Havayolu" prop="airlineId">
              <el-select v-model="flightForm.airlineId" placeholder="Havayolu se√ßin" style="width: 100%">
                <el-option 
                  v-for="airline in airlines" 
                  :key="airline.id" 
                  :label="airline.name" 
                  :value="airline.id" 
                />
              </el-select>
            </el-form-item>
          </el-col>
        </el-row>
        
        <el-row :gutter="20">
          <el-col :span="12">
            <el-form-item label="U√ßak" prop="aircraftId">
              <el-select v-model="flightForm.aircraftId" placeholder="U√ßak se√ßin" style="width: 100%">
                <el-option 
                  v-for="aircraft in aircrafts" 
                  :key="aircraft.id" 
                  :label="aircraft.registration" 
                  :value="aircraft.id" 
                />
              </el-select>
            </el-form-item>
          </el-col>
          
          <el-col :span="12">
            <el-form-item label="U√ßu≈ü Tipi" prop="flightTypeId">
              <el-select v-model="flightForm.flightTypeId" placeholder="U√ßu≈ü tipi se√ßin" style="width: 100%">
                <el-option 
                  v-for="type in flightTypes" 
                  :key="type.id" 
                  :label="type.name" 
                  :value="type.id" 
                />
              </el-select>
            </el-form-item>
          </el-col>
        </el-row>
        
        <el-row :gutter="20">
          <el-col :span="12">
            <el-form-item label="Kalkƒ±≈ü ƒ∞stasyonu" prop="originStationId">
              <el-select v-model="flightForm.originStationId" placeholder="Kalkƒ±≈ü istasyonu se√ßin" style="width: 100%">
                <el-option 
                  v-for="station in stations" 
                  :key="station.id" 
                  :label="station.name" 
                  :value="station.id" 
                />
              </el-select>
            </el-form-item>
          </el-col>
          
          <el-col :span="12">
            <el-form-item label="Varƒ±≈ü ƒ∞stasyonu" prop="destinationStationId">
              <el-select v-model="flightForm.destinationStationId" placeholder="Varƒ±≈ü istasyonu se√ßin" style="width: 100%">
                <el-option 
                  v-for="station in stations" 
                  :key="station.id" 
                  :label="station.name" 
                  :value="station.id" 
                />
              </el-select>
            </el-form-item>
          </el-col>
        </el-row>
        
        <el-row :gutter="20">
          <el-col :span="12">
            <el-form-item label="Kalkƒ±≈ü Zamanƒ±" prop="scheduledDeparture">
              <el-date-picker
                v-model="flightForm.scheduledDeparture"
                type="datetime"
                placeholder="Kalkƒ±≈ü zamanƒ± se√ßin"
                style="width: 100%"
                format="YYYY-MM-DD HH:mm:ss"
                value-format="YYYY-MM-DD HH:mm:ss"
              />
            </el-form-item>
          </el-col>
          
          <el-col :span="12">
            <el-form-item label="Varƒ±≈ü Zamanƒ±" prop="scheduledArrival">
              <el-date-picker
                v-model="flightForm.scheduledArrival"
                type="datetime"
                placeholder="Varƒ±≈ü zamanƒ± se√ßin"
                style="width: 100%"
                format="YYYY-MM-DD HH:mm:ss"
                value-format="YYYY-MM-DD HH:mm:ss"
              />
            </el-form-item>
          </el-col>
        </el-row>
        
        <el-row :gutter="20">
          <el-col :span="12">
            <el-form-item label="Durum" prop="status">
              <el-select v-model="flightForm.status" placeholder="Durum se√ßin" style="width: 100%">
                <el-option label="Zamanƒ±nda" value="ON_TIME" />
                <el-option label="Gecikmeli" value="DELAYED" />
                <el-option label="ƒ∞ptal" value="CANCELLED" />
              </el-select>
            </el-form-item>
          </el-col>
          
          <el-col :span="12">
            <el-form-item label="A√ßƒ±klama" prop="description">
              <el-input v-model="flightForm.description" placeholder="A√ßƒ±klama" />
            </el-form-item>
          </el-col>
        </el-row>
        
        <el-form-item>
          <el-button type="primary" @click="handleSubmit" :loading="submitting">
            G√ºncelle
          </el-button>
          <el-button @click="$router.push('/flights')">
            ƒ∞ptal
          </el-button>
        </el-form-item>
      </el-form>
    </el-card>
  </div>
</template>

<script>
import { ref, reactive, onMounted } from 'vue'
import { useRouter, useRoute } from 'vue-router'
import { ElMessage } from 'element-plus'
import api from '../services/api'
import nativeWebSocketService from '@/services/nativeWebSocketService'

export default {
  name: 'FlightEdit',
  setup() {
    const router = useRouter()
    const route = useRoute()
    const flightFormRef = ref()
    const loading = ref(true)
    const submitting = ref(false)
    
    const flightForm = reactive({
      flightNumber: '',
      airlineId: null,
      aircraftId: null,
      originStationId: null,
      destinationStationId: null,
      scheduledDeparture: '',
      scheduledArrival: '',
      flightTypeId: null,
      status: 'ON_TIME',
      description: ''
    })
    
    const airlines = ref([])
    const aircrafts = ref([])
    const stations = ref([])
    const flightTypes = ref([])
    
    const rules = {
      flightNumber: [
        { required: true, message: 'U√ßu≈ü numarasƒ± gerekli', trigger: 'blur' }
      ],
      airlineId: [
        { required: true, message: 'Havayolu se√ßimi gerekli', trigger: 'change' }
      ],
      aircraftId: [
        { required: true, message: 'U√ßak se√ßimi gerekli', trigger: 'change' }
      ],
      originStationId: [
        { required: true, message: 'Kalkƒ±≈ü istasyonu gerekli', trigger: 'change' }
      ],
      destinationStationId: [
        { required: true, message: 'Varƒ±≈ü istasyonu gerekli', trigger: 'change' }
      ],
      scheduledDeparture: [
        { required: true, message: 'Kalkƒ±≈ü zamanƒ± gerekli', trigger: 'change' }
      ],
      scheduledArrival: [
        { required: true, message: 'Varƒ±≈ü zamanƒ± gerekli', trigger: 'change' }
      ],
      flightTypeId: [
        { required: true, message: 'U√ßu≈ü tipi gerekli', trigger: 'change' }
      ]
    }
    
    const loadFlight = async () => {
      try {
        const flightId = route.params.id
        const response = await api.get(`/v1/flights/${flightId}`)
        const flight = response.data
        
        Object.assign(flightForm, {
          flightNumber: flight.flightNumber,
          airlineId: flight.airlineId,
          aircraftId: flight.aircraftId,
          originStationId: flight.originStationId,
          destinationStationId: flight.destinationStationId,
          scheduledDeparture: flight.scheduledDeparture,
          scheduledArrival: flight.scheduledArrival,
          flightTypeId: Array.isArray(flight.flightTypeId) ? flight.flightTypeId[0] : flight.flightTypeId,
          status: flight.status,
          description: flight.description
        })
      } catch (error) {
        ElMessage.error('U√ßu≈ü bilgileri y√ºklenirken hata olu≈ütu')
        console.error('Error loading flight:', error)
      }
    }
    
    const loadReferenceData = async () => {
      try {
        const [airlinesRes, aircraftsRes, stationsRes, flightTypesRes] = await Promise.all([
          api.get('/v1/airlines'),
          api.get('/v1/aircrafts'),
          api.get('/v1/stations'),
          api.get('/v1/flight-types')
        ])
        
        airlines.value = airlinesRes.data
        aircrafts.value = aircraftsRes.data
        stations.value = stationsRes.data
        flightTypes.value = flightTypesRes.data
      } catch (error) {
        ElMessage.error('Referans veriler y√ºklenirken hata olu≈ütu')
        console.error('Error loading reference data:', error)
      }
    }
    
    const handleSubmit = async () => {
      try {
        await flightFormRef.value.validate()
        submitting.value = true
        
        const flightId = route.params.id
        const response = await api.put(`/v1/flights/${flightId}`, flightForm)
        const updatedFlight = response.data
        
        ElMessage.success('U√ßu≈ü ba≈üarƒ±yla g√ºncellendi')
        
        try {
          console.log('üì§ WebSocket ile u√ßu≈ü g√ºncellemesi g√∂nderiliyor...')
          nativeWebSocketService.sendFlightUpdate('UPDATE', updatedFlight)
          console.log('‚úÖ WebSocket mesajƒ± g√∂nderildi')
        } catch (wsError) {
          console.error('‚ùå WebSocket mesajƒ± g√∂nderilemedi:', wsError)
        }
        
        router.push('/flights')
      } catch (error) {
        if (error.response?.status === 400) {
          ElMessage.error('Ge√ßersiz veri formatƒ±')
        } else {
          ElMessage.error('U√ßu≈ü g√ºncellenirken hata olu≈ütu')
          console.error('Error updating flight:', error)
        }
      } finally {
        submitting.value = false
      }
    }
    
    onMounted(async () => {
      await Promise.all([loadReferenceData(), loadFlight()])
      loading.value = false
    })
    
    return {
      flightForm,
      flightFormRef,
      rules,
      loading,
      submitting,
      airlines,
      aircrafts,
      stations,
      flightTypes,
      handleSubmit
    }
  }
}
</script>

<style scoped>
.flight-edit {
  padding: 20px;
}

.loading {
  padding: 20px;
}
</style>